#!/usr/bin/env bash

# ==============================================================================
# List Requests - Muestra todas las peticiones disponibles en archivos .http
# ==============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REQUESTS_DIR="$SCRIPT_DIR/../requests"

# Colores
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  Peticiones HTTP Disponibles${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

for file in "$REQUESTS_DIR"/*.http; do
    filename=$(basename "$file")
    echo -e "${GREEN}ðŸ“„ $filename${NC}"

    # Extraer descripciÃ³n de cada peticiÃ³n (comentario despuÃ©s de ###)
    awk '
        /^###/ {
            req_num++;
            getline;
            if ($0 ~ /^#/) {
                desc = substr($0, 3);
                gsub(/^[ \t]+/, "", desc);
                printf "   %d. %s\n", req_num, desc;
            }
        }
        /^(GET|POST|PUT|PATCH|DELETE)/ && req_num > last_printed {
            if (last_printed < req_num && desc == "") {
                printf "   %d. %s %s\n", req_num, $1, $2;
            }
            last_printed = req_num;
            desc = "";
        }
    ' "$file"

    echo ""
done

echo -e "${YELLOW}Uso con httpyac:${NC}"
echo -e "  httpyac <archivo.http> --dotenv api-tests/.env.local"
echo -e ""
echo -e "${YELLOW}Ejemplos:${NC}"
echo -e "  httpyac api-tests/requests/auth.http --dotenv api-tests/.env.local    ${GREEN}# Ejecutar todas las requests de auth${NC}"
echo -e "  httpyac api-tests/requests/auth.http --request login --dotenv api-tests/.env.local    ${GREEN}# Solo login${NC}"
echo -e "  httpyac api-tests/requests --dotenv api-tests/.env.local    ${GREEN}# Ejecutar todos los archivos${NC}"
echo ""
echo -e "${YELLOW}Atajo para login:${NC}"
echo -e "  ./token    ${GREEN}# Login y guardar tokens${NC}"
echo ""
