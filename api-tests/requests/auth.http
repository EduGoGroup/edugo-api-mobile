###
# Autenticación - Login
# Obtiene access_token y refresh_token
#
# FLUJO AUTOMÁTICO:
# 1. Ejecuta desde terminal: ./token
# 2. El script actualiza .vscode/settings.json automáticamente
# 3. Usa {{access_token}} en cualquier archivo .http
#
# FLUJO MANUAL (httpyac):
# 1. Ejecuta la request nombrada `login` (httpyac respetará el nombre)
# 2. El script post-request exporta `access_token` y `refresh_token` como variables para el resto de archivos
# 3. Puedes ejecutar secuencias con httpyac (ej: httpyac auth.http)
#
# @name login
POST {{baseUrl}}/v1/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}"
}

{{
  // post-request script: export tokens to variables usable por httpyac
  // exports made here are available as {{access_token}} and {{refresh_token}}
  try {
    exports.access_token = response.parsedBody && (response.parsedBody.access_token || response.parsedBody.token || response.parsedBody.data && response.parsedBody.data.access_token);
    exports.refresh_token = response.parsedBody && (response.parsedBody.refresh_token || response.parsedBody.data && response.parsedBody.data.refresh_token);
  } catch (e) {
    // no-op
  }
  // Imprimir tokens en una línea JSON para que scripts externos (run-httpyac.sh) puedan capturarlos
  try {
    console.info(JSON.stringify({__httpyac_tokens: true, access_token: exports.access_token, refresh_token: exports.refresh_token}));
  } catch (e) {}
  test.status(200);
}}

###
# Autenticación - Refresh Token
# Renueva el access_token usando refresh_token
# @name refresh
POST {{baseUrl}}/v1/auth/refresh
Content-Type: application/json

{
  "refresh_token": "{{refresh_token}}"
}

{{
  // export new tokens if present
  try {
    exports.access_token = response.parsedBody && (response.parsedBody.access_token || response.parsedBody.token);
    exports.refresh_token = response.parsedBody && (response.parsedBody.refresh_token || response.parsedBody.data && response.parsedBody.data.refresh_token);
  } catch (e) {}
  try {
    console.info(JSON.stringify({__httpyac_tokens: true, access_token: exports.access_token, refresh_token: exports.refresh_token}));
  } catch (e) {}
  test.status(200);
}}

###
# Autenticación - Logout
# Revoca el refresh_token actual (requiere auth)
POST {{baseUrl}}/v1/auth/logout
Authorization: Bearer {{access_token}}
Content-Type: application/json

{
  "refresh_token": "{{refresh_token}}"
}

{{
  // logout expected 200/204
  test.status(200);
}}

###
# Autenticación - Revocar Todas las Sesiones
# Cierra todas las sesiones activas del usuario (requiere auth)
POST {{baseUrl}}/v1/auth/revoke-all
Authorization: Bearer {{access_token}}

{{
  test.status(200);
}}
