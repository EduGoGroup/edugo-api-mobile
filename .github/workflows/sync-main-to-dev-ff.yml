name: Sync Main to Dev (Fast-Forward)

on:
  push:
    branches: [main]
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  sync-ff:
    name: Fast-forward dev to main
    runs-on: ubuntu-latest
    # Solo ejecutar si NO es un commit de sincronizaciÃ³n
    if: "!contains(github.event.head_commit.message, 'chore: sync')"

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verificar si dev existe
        id: check_dev
        run: |
          if git ls-remote --heads origin dev | grep -q dev; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ“ Rama dev existe"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Rama dev no existe, se crearÃ¡"
          fi

      - name: Crear rama dev si no existe
        if: steps.check_dev.outputs.exists == 'false'
        run: |
          git checkout -b dev
          git push -u origin dev
          echo "âœ“ Rama dev creada desde main"

      - name: Fast-forward dev a main
        if: steps.check_dev.outputs.exists == 'true'
        run: |
          # Fetch dev
          git fetch origin dev
          
          # Checkout dev
          git checkout -b dev origin/dev
          
          # Verificar si dev estÃ¡ detrÃ¡s de main (puede hacer fast-forward)
          if git merge-base --is-ancestor dev main; then
            echo "âœ… dev estÃ¡ detrÃ¡s de main, haciendo fast-forward..."
            
            # Fast-forward merge (sin crear merge commit)
            git merge --ff-only main
            
            # Push
            git push origin dev
            
            echo "âœ… dev sincronizado con main (fast-forward)"
            echo "ğŸ“ dev y main ahora apuntan al mismo commit"
          else
            echo "âš ï¸ ADVERTENCIA: dev tiene commits que main no tiene"
            echo "âš ï¸ No se puede hacer fast-forward automÃ¡tico"
            echo "âš ï¸ AcciÃ³n manual requerida"
            
            # Mostrar divergencia
            echo ""
            echo "Commits en dev que NO estÃ¡n en main:"
            git log --oneline main..dev
            
            exit 1
          fi

      - name: Verificar sincronizaciÃ³n
        run: |
          MAIN_SHA=$(git rev-parse origin/main)
          DEV_SHA=$(git rev-parse origin/dev)
          
          echo "# ğŸ”„ VerificaciÃ³n de SincronizaciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Rama | SHA |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| main | \`$MAIN_SHA\` |" >> $GITHUB_STEP_SUMMARY
          echo "| dev  | \`$DEV_SHA\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$MAIN_SHA" = "$DEV_SHA" ]; then
            echo "âœ… **SINCRONIZADAS**: main y dev apuntan al mismo commit" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ERROR**: main y dev NO estÃ¡n sincronizadas" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Resumen
        run: |
          echo "âœ… SincronizaciÃ³n completada"
          echo "ğŸ“ main y dev ahora tienen el mismo historial"
          echo "ğŸ” Verificar: git log --oneline main..dev (debe estar vacÃ­o)"
