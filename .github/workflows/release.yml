name: Release CI/CD

# Se ejecuta cuando creas un tag de versiÃ³n o manualmente
on:
  push:
    tags:
      - 'v*'  # v0.1.0, v1.0.0, etc.
  workflow_dispatch:  # EjecuciÃ³n manual si el tag no dispara automÃ¡ticamente
    inputs:
      tag:
        description: 'Tag de versiÃ³n (ejemplo: v0.1.0)'
        required: true
        type: string

env:
  GO_VERSION: '1.25.3'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate-and-test:
    name: Validate and Test Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Configurar acceso a repos privados
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: Descargar dependencias
        run: go mod download

      - name: Verificar formato
        run: |
          if ! gofmt -l . | grep -q .; then
            echo "âœ“ CÃ³digo formateado correctamente"
          else
            echo "âœ— CÃ³digo no estÃ¡ formateado:"
            gofmt -l .
            exit 1
          fi

      - name: AnÃ¡lisis estÃ¡tico (go vet)
        run: go vet ./...

      - name: Ejecutar tests
        run: go test -v -race ./...

      - name: Tests con cobertura
        run: |
          mkdir -p coverage
          go test -v -race -coverprofile=coverage/coverage.out -covermode=atomic ./... || true
          if [ -f coverage/coverage.out ]; then
            echo "ðŸ“Š Cobertura de cÃ³digo:"
            go tool cover -func=coverage/coverage.out | tail -5
          fi

      - name: Verificar build
        run: go build -v ./...

      - name: Subir cobertura
        uses: codecov/codecov-action@v3
        if: success()
        with:
          file: coverage/coverage.out
          flags: release
          name: codecov-release
          fail_ci_if_error: false

  build-docker-image:
    name: Build Docker Image for Release
    needs: validate-and-test
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Obtener tag de versiÃ³n
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG=${GITHUB_REF#refs/tags/}
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ VersiÃ³n: $TAG"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login a GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extraer metadata para Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
            type=sha,prefix=${{ steps.tag.outputs.tag }}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
            VERSION=${{ steps.tag.outputs.tag }}
            BUILD_DATE=${{ github.event.repository.updated_at }}

      - name: Resumen de imagen Docker
        run: |
          echo "# ðŸ³ Docker Image Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags generados:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-and-test, build-docker-image]
    permissions:
      contents: write

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Obtener tag actual
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG=${GITHUB_REF#refs/tags/}
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ VersiÃ³n: $TAG"

      - name: Extraer changelog para esta versiÃ³n
        id: changelog
        run: |
          TAG=${{ steps.tag.outputs.tag }}

          # Intentar extraer del CHANGELOG.md si existe
          if [ -f CHANGELOG.md ] && grep -q "## \[${{ steps.tag.outputs.version }}\]" CHANGELOG.md; then
            CHANGELOG=$(sed -n "/## \[${{ steps.tag.outputs.version }}\]/,/## \[/p" CHANGELOG.md | sed '$d')
          else
            # Generar changelog desde commits
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 $TAG^ 2>/dev/null || echo "")
            if [ -n "$PREVIOUS_TAG" ]; then
              CHANGELOG="## Cambios desde $PREVIOUS_TAG\n\n$(git log $PREVIOUS_TAG..$TAG --pretty=format:'- %s (%h)' --no-merges)"
            else
              CHANGELOG="Release $TAG"
            fi
          fi

          # Guardar a archivo
          echo -e "$CHANGELOG" > /tmp/changelog.md

      - name: Crear GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=${{ steps.tag.outputs.tag }}

          gh release create "$TAG" \
            --title "EduGo API Mobile $TAG" \
            --notes-file /tmp/changelog.md \
            --notes "

          ---

          ## ðŸ³ Imagen Docker

          La imagen Docker para esta versiÃ³n estÃ¡ disponible en GitHub Container Registry:

          \`\`\`bash
          # Pull de la imagen
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.version }}

          # O usar latest (apunta a esta versiÃ³n)
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          \`\`\`

          ### Ejecutar la imagen:

          \`\`\`bash
          docker run -d \\
            -p 8080:8080 \\
            -e APP_ENV=production \\
            -e POSTGRES_PASSWORD=your_password \\
            -e MONGODB_URI=your_mongo_uri \\
            -e RABBITMQ_URL=your_rabbitmq_url \\
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.version }}
          \`\`\`

          ## ðŸ“š DocumentaciÃ³n

          - **Swagger UI:** \`http://localhost:8080/swagger/index.html\`
          - **Health Check:** \`http://localhost:8080/health\`

          ## ðŸ”§ Dependencias

          - **Go:** ${{ env.GO_VERSION }}
          - **edugo-shared:** v2.0.5 (arquitectura modular)

          ## ðŸ“Š Cobertura de Tests

          Los reportes de cobertura estÃ¡n disponibles en los artifacts del workflow.

          ## ðŸ› ï¸ Build Info

          - **Commit:** \`${{ github.sha }}\`
          - **Branch:** \`${{ github.ref_name }}\`
          - **Fecha:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ---

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"

      - name: Resumen de release
        run: |
          echo "# ðŸŽ‰ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[Ver Release en GitHub](https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
