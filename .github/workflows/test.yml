name: Tests with Coverage (Manual)

# Solo ejecuciÃ³n manual - Los PRs usan workflows especÃ­ficos
on:
  workflow_dispatch: # Manual desde GitHub UI
    inputs:
      test_type:
        description: "Tipo de tests a ejecutar"
        type: choice
        options:
          - unit
          - integration
          - all
        default: all
      coverage_threshold:
        description: "Umbral de cobertura (%)"
        type: number
        default: 33
      skip_coverage_check:
        description: "Saltar verificaciÃ³n de umbral"
        type: boolean
        default: false

env:
  GO_VERSION: "1.25"
  ENABLE_COVERAGE_CHECK: true # â† Control ON/OFF
  COVERAGE_THRESHOLD: 33

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_type == 'unit' ||
      github.event.inputs.test_type == 'all'
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ” Configurar acceso a repos privados
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: ğŸ“¦ Descargar dependencias
        run: go mod download

      - name: ğŸ§ª Ejecutar tests unitarios
        run: make test-unit
        timeout-minutes: 5

      - name: ğŸ“Š Generar reporte de cobertura
        run: make coverage-report
        timeout-minutes: 5

      - name: âœ… Verificar umbral de cobertura
        if: github.event.inputs.skip_coverage_check != 'true'
        run: |
          THRESHOLD=${{ github.event.inputs.coverage_threshold || env.COVERAGE_THRESHOLD }}
          ./scripts/check-coverage.sh coverage/coverage-filtered.out $THRESHOLD || {
            echo "::warning::Cobertura por debajo del umbral de ${THRESHOLD}%"
            exit 1
          }
        continue-on-error: false

      - name: ğŸ“¤ Subir reporte de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-manual
          path: coverage/
          retention-days: 30

      - name: ğŸ“ˆ Subir a Codecov
        uses: codecov/codecov-action@v3
        if: success()
        with:
          file: coverage/coverage.out
          flags: unittests
          name: codecov-edugo-api-mobile
          fail_ci_if_error: false

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_type == 'integration' ||
      github.event.inputs.test_type == 'all'
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Configurar acceso a repos privados
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: ğŸ“¦ Descargar dependencias
        run: go mod download

      - name: ğŸ³ Verificar Docker
        run: |
          docker --version
          docker ps

      - name: ğŸ§ª Ejecutar tests de integraciÃ³n
        env:
          RUN_INTEGRATION_TESTS: "true"
        run: make test-integration
        timeout-minutes: 10

      - name: ğŸ§¹ Limpiar contenedores Docker
        if: always()
        run: |
          docker ps -a | grep -E "postgres|mongo|rabbitmq" | awk '{print $1}' | xargs -r docker rm -f || true
