name: Integration Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch: # Permite ejecutar manualmente
    inputs:
      run_integration_tests:
        description: 'Ejecutar tests de integraciÃ³n'
        required: true
        type: boolean
        default: true

env:
  GO_VERSION: '1.21'

jobs:
  integration-tests:
    name: Tests de IntegraciÃ³n
    runs-on: ubuntu-latest
    
    # âš™ï¸ CONTROL: Puedes deshabilitar todo el job con esta condiciÃ³n
    # if: github.event.inputs.run_integration_tests != 'false'
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Download dependencies
        run: go mod download
      
      # ğŸ³ Docker ya estÃ¡ disponible en ubuntu-latest
      - name: Verificar Docker
        run: docker ps
      
      # âœ… OpciÃ³n 1: Ejecutar tests (HABILITADOS)
      - name: Run integration tests
        if: github.event.inputs.run_integration_tests != 'false'
        env:
          RUN_INTEGRATION_TESTS: true
        run: |
          go test -v -tags=integration ./test/integration/... -timeout 10m
      
      # â­ï¸ OpciÃ³n 2: Skip tests (DESHABILITADOS)
      # Descomentar si quieres forzar skip temporalmente
      # - name: Skip integration tests
      #   if: github.event.inputs.run_integration_tests == 'false'
      #   env:
      #     SKIP_INTEGRATION_TESTS: true
      #   run: |
      #     echo "â­ï¸  Integration tests disabled"
      #     go test -v -tags=integration ./test/integration/... -timeout 10m
      
      # ğŸ“Š Coverage (opcional)
      - name: Upload coverage
        if: github.event.inputs.run_integration_tests != 'false'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/integration-coverage.out
          flags: integration
          name: integration-coverage

  # ğŸš¨ Job separado que SIEMPRE se puede deshabilitar con variable
  integration-tests-conditional:
    name: Tests de IntegraciÃ³n (Condicional)
    runs-on: ubuntu-latest
    
    # Este job solo corre si la variable estÃ¡ configurada
    if: vars.ENABLE_INTEGRATION_TESTS == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Run tests
        env:
          RUN_INTEGRATION_TESTS: true
        run: make test-integration

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ğŸ“ CONFIGURACIÃ“N EN GITHUB
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# Para usar variables en GitHub Actions:
#
# 1. IR A: Settings â†’ Secrets and variables â†’ Actions â†’ Variables
#
# 2. CREAR VARIABLE:
#    Name: ENABLE_INTEGRATION_TESTS
#    Value: true  (o false para deshabilitar)
#
# 3. USAR EN WORKFLOW:
#    if: vars.ENABLE_INTEGRATION_TESTS == 'true'
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# CASOS DE USO:
#
# 1. Deshabilitar temporalmente (sin modificar cÃ³digo):
#    - Cambiar ENABLE_INTEGRATION_TESTS a 'false' en GitHub
#    - Los PRs seguirÃ¡n corriendo pero tests se skipean
#
# 2. Habilitar solo en main/prod:
#    if: github.ref == 'refs/heads/main'
#
# 3. Ejecutar manualmente:
#    - GitHub UI â†’ Actions â†’ Integration Tests â†’ Run workflow
#    - Elegir si ejecutar o no tests
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
