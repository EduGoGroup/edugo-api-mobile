name: PR to Dev - Unit Tests

# Se ejecuta en PRs de feature branches hacia dev
on:
  pull_request:
    branches: [dev]
    types: [opened, synchronize, reopened]

env:
  GO_VERSION: "1.25"
  COVERAGE_THRESHOLD: 33

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ” Configurar acceso a repos privados
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: ğŸ“¦ Descargar dependencias
        run: go mod download

      - name: ğŸ§ª Ejecutar tests unitarios
        run: make test-unit
        timeout-minutes: 5

      - name: ğŸ“Š Generar reporte de cobertura
        run: make coverage-report
        timeout-minutes: 5

      - name: âœ… Verificar umbral de cobertura
        if: |
          !contains(github.event.pull_request.labels.*.name, 'skip-coverage')
        run: |
          ./scripts/check-coverage.sh coverage/coverage-filtered.out ${{ env.COVERAGE_THRESHOLD }} || {
            echo "::warning::Cobertura por debajo del umbral de ${COVERAGE_THRESHOLD}%"
            echo "ğŸ’¡ Tip: Agrega label 'skip-coverage' al PR si es temporal"
            exit 1
          }
        continue-on-error: false

      - name: ğŸ“¤ Subir reporte de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-unit
          path: coverage/
          retention-days: 7

      - name: ğŸ“ˆ Comentar cobertura en PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('coverage/coverage-filtered.out', 'utf8');
            const lines = coverage.split('\n');
            const totalLine = lines[lines.length - 2];
            const match = totalLine.match(/(\d+\.\d+)%/);
            const coveragePercent = match ? match[1] : 'N/A';

            const comment = `## ğŸ“Š Cobertura de Tests Unitarios

            **Cobertura Total**: ${coveragePercent}%
            **Umbral MÃ­nimo**: ${process.env.COVERAGE_THRESHOLD}%

            ${parseFloat(coveragePercent) >= parseFloat(process.env.COVERAGE_THRESHOLD) ? 'âœ… Cobertura cumple con el umbral' : 'âš ï¸ Cobertura por debajo del umbral'}

            ğŸ“„ [Ver reporte completo](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # =====================================================
  # MIGRADO: Job lint usando workflow reusable
  # Migrado en SPRINT-4 para usar workflows centralizados
  # Ver: edugo-infrastructure/.github/workflows/reusable-go-lint.yml
  # =====================================================
  lint:
    name: Lint & Format Check
    uses: EduGoGroup/edugo-infrastructure/.github/workflows/reusable-go-lint.yml@main
    with:
      go-version: "1.25"
      args: "--timeout=5m"

  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, lint]
    if: always()

    steps:
      - name: ğŸ“‹ Generar resumen
        uses: actions/github-script@v7
        with:
          script: |
            const unitTests = '${{ needs.unit-tests.result }}';
            const lint = '${{ needs.lint.result }}';

            const statusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¸ï¸';
                default: return 'âš ï¸';
              }
            };

            const summary = `## ğŸ” Resumen de Checks - PR a Dev

            | Check | Estado |
            |-------|--------|
            | Tests Unitarios | ${statusEmoji(unitTests)} ${unitTests} |
            | Lint & Format | ${statusEmoji(lint)} ${lint} |

            ${unitTests === 'success' && lint === 'success' ? 'âœ… **Todos los checks pasaron** - PR listo para review' : 'âš ï¸ **Algunos checks fallaron** - Por favor revisa los errores'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
